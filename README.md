Emails are one of the most popular methods used by an attacker to achieve initial access. Specifically, using the technique of phishing. As a SOC analyst, you must understand how to analyze emails. In today's lesson, I'll walk you through a lab from Blue Team Cyber Range called, "The Planet's Prestige" and I would encourage you to follow along to get the most out of this lesson. Let's get started.

All right, heading over to Blue Team labs Online and if you don't have an account yet you can register for one here, but if you do you can go ahead and just hit log in and log into your account. Once you're logged in, you want to go and select "Challenges" which is located at the top.

Next, you want to search "planet" and hit "Enter". You should see "The Planet's Prestige". So we'll go ahead and hit "Start Challenge". Very quickly we'll go over the scenario here. "CoCanDa, a planet known as 'The Heaven of the Universe' has been having a bad year. A series of riots have taken place across the planet due to the frequent abduction of citizens, known as CoCanDians, by a mysterious force. CoCanDa's Planetary President arranged a war-room with the best brains and military leaders to work on a solution. After the meeting concluded the President was informed his daughter had disappeared. CoCanDa agents spread across multiple planets were working day and night to locate her. Two days later and there's no update on the situation, no demand for ransom, not even a single clue regarding the whereabouts of the missing people. On the third day a CoCanDa representative, an Army Major on Earth, received an email." 


This is a pretty interesting scenario where we will go into the email that the Army Major had received. So let's go ahead and start downloading the email itself. I'll click on "Download File" and you do want to keep in mind of the password. The password is "btlo". For my machine, I'll be using a Windows Virtual Machine to perform my analysis using notepad++, but you can use whatever text editor you like.

I'll also use an application called 'HXD'. Which is what I'll use to view some files in HEX, and lastly, I'll have 7-zip installed as well. Once the file is downloaded just right-click it and click on "Extract All..." We'll go ahead and extract it using the password "btlo" and now we have the email file. I'll go ahead and right-click this email file and click on "Edit with Notepad++".

If this is your first time analyzing emails, it can be quite confusing. Especially, with the amount of information you see here, but let's just take it slow. I'll start from the top. The first field is "Delivered-To". This field is who received the email, which in our case, it is "themajoronearth@gmail.com". 

Next, we have "Received", these are email servers that have received the email. Similar to how post office delivers their mail. The mail will end up in multiple post offices, before reaching the post office that is closest to the recipient. So the first "Received: by" from the top is the closest mail server to the recipient. Whereas if we were to scroll down just a little bit. The first received field is going to be the one closest to the sender. 

So just so we're all on the same page at the bottom, the very first received field is going to be the mail server that's closest to the sender. Whereas all the way at the top, the first received field from the top is going to be closest to the recipient. Next, are headers that have an "x" appended to the front. These are called 'X-Headers' and they are optional and included by tools or mail servers. 

Then, we have what are called "ARC Headers", AKA 'Authenticated Received Chain Headers'. These are used for verification purposes by having a trusted intermediate email server digitally sign the header. Scrolling down just a bit, passing all of the ARC Headers, we get a "Return-Path". This is the email address that will be used if the email fails to send, which is typically used for troubleshooting purposes.

Now, I'm sure you've experienced this once upon a time where you tried to send an email, but then you got an email failed to deliver. Since the email failed to deliver, your email address was likely put into the return path. Moving down just a bit, we have "Authentication-Results". This is where we can see the statuses for email protection such as 'SPF', 'DKIM' and 'DMARK'.

As we can see, SPF is currently set to fail. Meaning that the domain of "microapple", does not permit the mail server of '93.99.104.210' as a permitted sender. In other words, MicroApple.com does not know who '93.99.104.210' is. 

When you're performing email analysis, looking at the 'SPF', 'DKIM', and 'DMARK' statuses is a good indicator of suspicious emails. If SPF is set to fail, you might want to take a deeper look into it. We have "To", which is the recipient, the subject, and the from. So who sent the email.

Now if we were to just scroll down a little bit, we have the "Importance" set to "Normal". These are quite self-explanatory. Then, we have "Reply-To". So the "Reply-To" email address that is listed here is what will be used when the recipient clicks on "Reply" to the email.

If you also notice, the email has a domain of "pashter.com" and then if we look at the "From" email, it is from "microaapple.com". Since there's a discrepancy between the two, that I pretty suspicious. Not only did SPF fail, but the email addresses in the "From" and "Reply-To" field are different.


For "Content-Type", this field is to instruct the mail server on how to render the content of the email, with it being multi-art/mixed. That means there are multiple formats and it also has a boundary set for it. Where the boundary is "BOUND_600". A boundary is used to let the mail server know when to start and stop rendering the contents using a certain format.

Next, we have "Message-Id", which is a unique identifier to help keep track of this email. Finally, we have the "Date", when the the recipient received the email. Now, do keep in mind that the date field can be spoofed.

We see our first boundary. Which will tell the mail server to start rendering the content using the following format. If we look at the "Content-Type", it says "text/plain". So it's telling the mail server to render this content using a plain text format. 

At the bottom, we see an encoding as well. Since you want to encode it using "Base64", so the mail server will render this using plain text alongside encoding it using "base64". Anytime we get hit with a base64, we want to start decoding it to see the contents of it. So we can highlight it. Right-click. Copy. Then we'll use a trusty tool called 'Cyberchef'.

Over on CyberChef, I'll go ahead and just paste that over into the input. Then, you can either search for Base64 or you click on 'From Base64' on the side. I'll drag that over and immediately at the bottom from the outputs we can see the output. It says, "Hi TheMajorOnEarth, The abducted CoCanDians are with me including the president's daughter. Don't worry. They are safe in a secret location. Send me 1 billion CoCanD's in cash, with a spaceship and my autonomous bots will safely bring back your citizens. I heard that CoCanDians have the best brains in the Universe. Solve the puzzle I sent as an attachment for the next steps. I'm approximately 12.8 light minutes away from the sun and my advice for the puzzle is, "Don't Trust Your Eyes". 

We can go ahead and click on "Save output to file". I'll name this as "email.txt". In the body of this email, they mentioned something about an attachment. So let's head back over to to our notepad++, and then we see the boundary again. Which will tell the mail server that this is the end for that particular piece of content.

If we scroll down, we see "application/pdf" with the name of "PuzzleToCoCanDa.pdf". So this is going to be the attachment that was mentioned in the body of the email. We do see the "Content-Transfering-Encoding" as "base64" and we see the base 64 content. 

Just like previously, I'll copy this. Head over to CyberChef, I'll add a new tab by clicking on the plus button. Let's paste that in. Now once we have the decoded base64, we can save out the output if we want, but before we do that. I'm going to select "To Hex" and convert this into hexadecimal. Now the reason I'm doing this is that if we take a look at the first couple bytes, '50', '4B' '03', and '04'. The first byte of a file makes up what is called a 'file signature', AKA a magic number or file header. 

Just because the file name right here is called "PuzzleToCoCanDa.pdf". It doesn't necessarily mean it is a PDF file. We want to always take a look at the file signature for a file to determine exactly what type of file it is. Going back over to CyberChef, I'll copy the first couple of bytes. Then, I'll go to use a site called "Gary Kesler file signature".

I'll press a cntrl+F and paste in those first couple bytes. Now we quickly see that the first couple of bytes relates to a zip extension. Now it did say "PDF" over to the file name, however, if we took a look at the file signature, it has a file extension of zip. What if searched for "PDF" instead. So I'll do that. Looking at the file extension. I am looking for PDF and not drmz let's just keep on clicking next and finally we have the PDF extension now the first couple bytes for the PDF is 25 50 44 46 and if we were to go back over to our cyberchef that is not the first couple bites pretty interesting right we can go and remove the two hex to have it all decoded and I will save this file and call it attachment. zip click on okay and now we have our zipped file now remember whenever you're doing any kind of analysis especially one that might contain mware always use a virtual machine and not your host I'll go ahead and open this up right click it and extract all click on extract and we get a puzzle to Canda directory so let's go ahead and open that up and we see two files here but just in case there are any hidden files I'm going to click click on view and check off hidden items and now we see an additional file called money. xlsx which is a file extension for Microsoft Excel now is that actually Excel that is something for us to figure out now because I do have a tool called hxd again link down below if you want to download it I can view these files in their hex format so I'll go ahead and drag daughter's Crown over to hxd and let's take a look at the first couple bytes so the first one here is FF d8 FF e0 let's go ahead and copy that head over to file signatures from Gary kler crlf and paste that in we can see that the first couple bytes relate to a JPEG file I am going to go back to the file and I'll click on rename and let's just add a JPEG extension to it and once that's added double click it and we get a picture nice let's do the same for the other one now just as an FYI you want to always enable file name extension because if you don't you won't be able to manually change the file extension here now sometimes you can it's kind of odd but just to make sure everything works properly always have file name extension checked open the hxt and then I'll click on new and let's drag over the good job major take a look at the first couple bites again we have 25 50 44 and 46 now if that sounded familiar to you that is because we checked this earlier which turned out to be a PDF so I'll go ahead and change good job major and I'll add the extension. PDF now we can double click it we see that it says Hey candians are safe the proof is in the file named daughter's Crown location to send 1 billion candies is in the money. xlsx file okay head over to the directory I'll open up another hxd and I'll drag in the money. xlsx the first couple bytes is 504b 0304 copy that out head over to file signatures and I'll paste that in now we do see azip file which is what we saw earlier however if we just kept going down just a little bit we do see Microsoft open Office XML format we can safely say that this is an Excel document now what if we don't have Excel installed on a virtual machine which I do not have now we can go ahead and install Excel or open office or what I'll do is use a tool called Square X they have a file viewer that you can use to drag and drop your files and then it will open it for you now you can go ahead and sign up with the link down below it is a tool that I always use during my analysis now that I opened up the file viewer I'll go ahead and just drag the money. xlsx file and into square x with this file it says whatever you have seen or read till now is fake Our intention was not for money it is the beginning of the war with Candian it's not that easy to find this major I will also stay in the same location but I bet candians can't do anything in my Planet find and come ASAP I'm waiting okay with this Excel file we do have two sheets so this one is sheet one this one is sheet three and Sheet three appears to have nothing in it and because this lab is like a CTF lab there might be some trickery in here where the text is Blended in using the colored white so what I'll do is I'll select everything right click and then I'll click on clear format that way if there's any kind of formatting happening I will see it right here so sheet one seems like it's all good but what what about sheet three because it's blank and there's a sheet it's kind of suspicious here so clear format and we do see a base 64 so go ahead and copy that head over to our cyberchef open up another tab by clicking on the plus and let's go ahead and paste that in so it says the Martian Colony nice okay I'll go ahead and copy that out and put that into our notes now let's do a quick recap before we head over to the questions because we just
Recap went over a a lot of things so we take a look at our email and scrolling back up the malicious actor sent an email from Bill jobs at micro.com to the major onar gmail.com with the subject of a hope to Canda on January 26 2021 at 14118 Eastern Standard Time the return path if we scroll up is set to Bill JW at micro apple.com so this email is going to receive any emails that were failed to deliver however if we take a look at the reply to it is a completely different email one that is ending I pastor.com if we scroll up just a little bit we can see that the malicious actor used an email service called mk. CZ and if we were to just search that up to see what that is and we can see that it is a fake mailer mk's fake mailer is a web-based tool that allows you to create and send fake emails so we know that the thread actor used an email service called MK and the contents of the email was a threat to the major on Earth demanding 1 billion in cash along with an attachment that was supposedly a PDF file but it actually turned out to be a zip file and within that zip it contained three files one jpeg one PDF and one Excel file the next thing I'm I'm about to say is extremely important so make sure that you take a note of it when performing email analysis there are some important fields that you should put more focus on and those are the following first and foremost received so these are the mail servers that received the email what you want to do is perform ENT on these mail servers so for example taking a look at the sender IP you want to check out the IP reputation you also want to check out the domain reputation as well and of course what we just did the email service this will provide you with some context when you're doing your analysis the next thing is return path look at the email address itself because if you recall the return path is the email address that will receive a failed or error in email delivery and then we have authentication results this is where you can find the status of SPF dkm and dmark remember any time you see SPF failed that is pretty weird and you should put more effort into investigating that email and then we have the two so this is the recipient who received that email then the subject itself which is the subject of the email if you have an email security Gateway or if you have the ability to search emails across your organization you can use the subject field to see who else received a similar email and then we have the from so who sent that email in this case we have the name Bill and the email of Bill jobs micro.com you always want to focus on the email address itself rather than the name now this can be spoofed of course but it's always a good idea to keep note of it because again you can always search your emails across your organization searching specifically emails that are sent from this user and then we have reply to so this is the email address that will be used if the recipient clicks on reply it is a quick win if you notice that the from email address and the reply to email address is different because if you think about this logically if I send you an email and you reply I want to get that reply why is that reply going to somebody else's email something like that which is a question that you should ask yourself and then we have content type this is how the mail server is going to render the content if you do see boundary that means you'll see multiple formats and then you have message ID this is incredibly useful again if you're searching emails across the organization this keeps track of where that email went and finally you have the date do keep in mind that the date can be spoofed but take note of it nonetheless as it is a good starting point again anytime you receive an email you want to focus on these fields as they can provide you with quick wins now in my course we go into more detail about email analysis and I'll also show you some other tools that you can use my course is going to be a paid course but it will be absolutely worth it trust me I'll leave a link down for you to sign up for the wait list if you're interested now let's move on to the questions so it says what is the email service used by the malicious actor now we know this by going back over we saw a fake email service that was used which is mk. CZ so I'll go ahead and copy that and I'll paste it here click on submit perfect what is the reply to email address that's pretty easy I'll go ahead and copy this one out now remember reply to is whenever the recipient clicks on reply that is going to be the email address for that paste that in hit submit what is the file type of the received attachment that helped to continue the investigation if we look at our email scrolling down we do see the content type as PDF but when we did our analysis it wasn't actually a PDF right it was azip file what is the name of the malicious actor hm this one's quite interesting if we take a look at the email let's see if there's a name here so we see the from field and it is from Bill but it's asking for a last name as well so bill is probably not the one unless you put in Bill jobs but if we think about it the reply to field is a different email address and because it is a different email address it makes me believe that this is actually the threat actor or the malicious actor here what we can do is use a tool called exit f tool and take a look at the metadata of the attachment itself because if the thread actor was responsible for creating it they might leave some clues in there to take a look at the metadata I'm going to be using a tool called XF tool and again I'll leave the download links down below so I'll use XF tool D to specify my files and I am going to take a look at the attachments so I'll go ahead and just copy the path and I'll paste it in here back slash with an ASX and using except tool will show us all the interesting metadata for these files here so we have the zip file name the mime type let's see file modification access and creation but nothing about a name and oh right here author so we can see a name Pasto nea I I don't know if that's how you pronounce it but there you go first and last name I'm going to assume that that is the one because it does match our reply to email right the last name Nea is right here paste that in hit submit and we got it perfect what is the location of the attacker in this universe H what is the location of the attacker in this universe okay um I do recall seeing this the Martian Colony this is the decoded Bas 64 that we we found in the Excel document called money so I'll go ahead and just copy that cuz this sounds like a location to me paste that in here and submit nice what could be the probable CNC so command and control domain to control the attacker's autonomous Bots taking a look at the email we do see pure.com from this malicious actors and there weren't any other URLs that we've seen other than the fake email service here but because this domain is tied to the malicious actor I'm going to assume that this is going to be the C2 domain going to go ahead and pasted it and submit and awesome we just completed it email analysis is something that you should frequently expect to see as a sock analyst and by learning what the important fields are will definitely help you in your investigations again if you're interested in my course the weit list to the link is down below I'll provide the pricing to you shortly once I have finalized all of the content and my goal here is to try and release it in sometime in May or by June but in the meantime continue to level up your skills and get better every single day that is it for the video and I hope you found that informative if you did please share this with other aspiring sock analysts And subscribe if you want to remember to stay curious and do things differently
